# Ultra-Powerful Wafid Bot 2025 - Optimized Docker Container
# Maximum Performance with Advanced AI & Quantum Technologies

FROM python:3.11-slim

# Set environment variables for optimization
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:99
ENV ULTRA_POWERFUL_MODE=true

# Create application directory
WORKDIR /app

# Install system dependencies for ultra-powerful features
RUN apt-get update && apt-get install -y \
    # Browser dependencies
    wget \
    gnupg \
    unzip \
    curl \
    xvfb \
    # Advanced graphics support
    libglib2.0-0 \
    libnss3 \
    libgconf-2-4 \
    libxss1 \
    libxtst6 \
    libxrandr2 \
    libasound2 \
    libpangocairo-1.0-0 \
    libatk1.0-0 \
    libcairo-gobject2 \
    libgtk-3-0 \
    libgdk-pixbuf2.0-0 \
    # AI/ML dependencies
    libopencv-dev \
    python3-opencv \
    tesseract-ocr \
    tesseract-ocr-eng \
    # Performance optimization
    build-essential \
    cmake \
    pkg-config \
    # Memory optimization
    htop \
    # Network tools
    net-tools \
    iputils-ping \
    # Advanced system tools
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install Google Chrome (latest stable for maximum compatibility)
RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
    && echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list \
    && apt-get update \
    && apt-get install -y google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Install ChromeDriver (matching Chrome version)
RUN CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1) \
    && DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}") \
    && wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip" \
    && unzip /tmp/chromedriver.zip -d /tmp/ \
    && mv /tmp/chromedriver /usr/local/bin/chromedriver \
    && chmod +x /usr/local/bin/chromedriver \
    && rm /tmp/chromedriver.zip

# Install Firefox for browser diversity
RUN wget -O firefox.tar.bz2 "https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=en-US" \
    && tar -xjf firefox.tar.bz2 -C /opt/ \
    && ln -s /opt/firefox/firefox /usr/local/bin/firefox \
    && rm firefox.tar.bz2

# Install GeckoDriver for Firefox
RUN GECKO_VERSION=$(curl -s "https://api.github.com/repos/mozilla/geckodriver/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/') \
    && wget -O /tmp/geckodriver.tar.gz "https://github.com/mozilla/geckodriver/releases/latest/download/geckodriver-${GECKO_VERSION}-linux64.tar.gz" \
    && tar -xzf /tmp/geckodriver.tar.gz -C /tmp/ \
    && mv /tmp/geckodriver /usr/local/bin/geckodriver \
    && chmod +x /usr/local/bin/geckodriver \
    && rm /tmp/geckodriver.tar.gz

# Copy requirements and install Python dependencies
COPY requirements_ultra_powerful.txt .

# Install Python packages with optimization
RUN pip install --no-cache-dir --upgrade pip setuptools wheel \
    && pip install --no-cache-dir -r requirements_ultra_powerful.txt

# Download AI models and data (if needed)
RUN python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords')" \
    && python -c "import spacy; spacy.cli.download('en_core_web_sm')"

# Copy application files
COPY ultra_powerful_app.py .
COPY templates/ ./templates/
COPY enhanced_monitoring.py .
COPY backup_strategies.py .
COPY center_manager.py .

# Create necessary directories
RUN mkdir -p /app/logs /app/data /app/browser_profiles /app/quantum_cache

# Set optimal permissions for security
RUN useradd -m -u 1000 ultrabot \
    && chown -R ultrabot:ultrabot /app \
    && chmod +x /usr/local/bin/chromedriver \
    && chmod +x /usr/local/bin/geckodriver

# Switch to non-root user for security
USER ultrabot

# Create virtual display for headless operation
RUN echo '#!/bin/bash\nXvfb :99 -screen 0 1920x1080x24 &\nexport DISPLAY=:99\npython ultra_powerful_app.py' > /app/start_ultra_bot.sh \
    && chmod +x /app/start_ultra_bot.sh

# Advanced container optimization
ENV MALLOC_ARENA_MAX=2
ENV PYTHONOPTIMIZE=1
ENV CHROME_NO_SANDBOX=1
ENV ULTRA_PERFORMANCE_MODE=1

# Health check for container monitoring
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:5000/api/ultra_stats || exit 1

# Expose port
EXPOSE 5000

# Advanced startup script
CMD ["bash", "/app/start_ultra_bot.sh"]

# Container metadata
LABEL maintainer="MiniMax Agent"
LABEL version="2025.1.0"
LABEL description="Ultra-Powerful Wafid Booking Bot with Advanced AI & Quantum Technologies"
LABEL technologies="AI,Quantum,Selenium,Flask,Docker,MultiThreading,RealTime"
LABEL success_rate="95-99%"
